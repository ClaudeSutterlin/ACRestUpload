/*! ACRestUploader 2015-01-31 */
function ACRestUpload(a){var b=this;return b.id=null,b.manualUpload=!1,b.fileArray=[],b.fileCnt=0,b.uploadingFileCnt=0,b.data=null,b.forceFallback=!1,b.html5Form={},b.fallbackDiv=null,b.fallbackForm=null,b.dropZone={},b.uploadList={},b.hiddenInput={},b.sf_sessionId="",b.finishedCallback=null,b.fileUploadCallback=null,b.finished=!1,b.fallbackMode=!1,b.useProxy=!0,b.uploadLimit=999,b.fallbackPageUrl="apex/ACRestUploadFallbackFrame",b.init=function(a){b.id=a.selector,b.html5Form=$j(b.id).children(".html5form"),b.dropZone=$j(b.html5Form).children(".dropZone"),b.hiddenInput=$j(b.html5Form).children(".hidden_input"),b.uploadList=$j(b.html5Form).children(".uploadList"),b.fallbackDiv=$j(b.id).children(".fallbackDiv"),b.fallbackFrame=$j(b.fallbackDiv).children(".fallbackFrame"),b.sf_sessionId=a.session,b.instanceUrl=a.instanceUrl},b.bindFallbackFrame=function(){var a=function(){$j(b.fallbackFrame).contents().find("[id$='data']").val(JSON.stringify(b.data)),b.fallbackForm=$j(b.fallbackFrame).get(0).contentWindow.fallbackForm,b.fallbackForm.setUploadLimit(b.uploadLimit),b.manualUpload&&b.fallbackForm.hideUploadButton();var a=b.fallbackForm.uploadFinished;a&&b.fallbackFinished()};$j(b.fallbackFrame).unbind("load"),$j(b.fallbackFrame).bind("load",a)},b.setData=function(a){b.data=a,$j(b.fallbackFrame).contents().find("[id$='data']").val(JSON.stringify(b.data))},b.prepareUpload=function(a){b.data=a.data,a.uploadLimit&&(b.uploadLimit=a.uploadLimit,b.applyUploadLimit());var c=window[a.fileUploadCallback];"function"==typeof c&&(b.fileUploadCallback=c),c=window[a.finishedCallback],"function"==typeof c&&(b.finishedCallback=c),b.forceFallback=a.forceFallback,b.checkFallback(),a.manualUpload&&(b.manualUpload=a.manualUpload),b.fileArray=[],b.fileCnt=0,$j(b.uploadList).empty()},b.applyUploadLimit=function(){var a="file"+(b.uploadLimit>1?"s":"");$j(b.html5Form).find(".uploadLimitLbl").text("max. "+b.uploadLimit+" "+a)},b.checkFallback=function(){var a=window.File&&window.FileReader&&window.FileList&&window.Blob&&supportAjaxUploadProgressEvents();!a||this.forceFallback?(b.bindFallbackFrame(),this.fallbackMode=!0,$j(b.fallbackFrame).attr("src",b.fallbackPageUrl),$j(b.fallbackDiv).show(),$j(b.html5Form).hide()):b.bindEvents()},b.startManualUpload=function(){b.fallbackMode?b.fallbackForm.startManualUpload():b.startUploads()},b.startUploads=function(){if(0==b.fileArray.length)b.finishedCallback();else for(u in b.fileArray){var a=b.fileArray[u];a.upload(),b.uploadingFileCnt++}},b.handleFileSelect=function(a){$j("#drop_zone").removeClass("dropZoneHovering"),a.stopPropagation(),a.preventDefault();var c=a.originalEvent.dataTransfer.files;b.handleFiles(c)},b.handleFiles=function(a){b.finished=!1;for(var c,d=0;c=a[d];d++){if(!(b.fileCnt<b.uploadLimit)){var e="file"+(b.uploadLimit>1?"s":"");return alert("You may only upload "+b.uploadLimit+" "+e),void 0}var f=new FileUpload(c,b.fileCnt,b);b.fileArray.push(f),b.fileCnt++,b.manualUpload||(f.upload(),b.uploadingFileCnt++)}},b.fileUploaded=function(a){b.uploadingFileCnt--,b.fileUploadCallback&&b.fileUploadCallback(a.fileName),0==b.uploadingFileCnt&&b.finishedCallback&&(b.finished=!0,b.finishedCallback())},b.handleDragLeave=function(){$j("#drop_zone").removeClass("dropZoneHovering")},b.handleDragOver=function(a){$j("#drop_zone").addClass("dropZoneHovering"),a.stopPropagation(),a.preventDefault(),a.originalEvent.dataTransfer.dropEffect="copy"},b.handleHiddenInputChange=function(){var a=this.files;a.length&&b.handleFiles(a)},b.handleClick=function(a){a.preventDefault(),b.hiddenInput.click()},b.fallbackFinished=function(){b.finished=!0,b.finishedCallback&&b.finishedCallback()},b.bindEvents=function(){b.dropZone.unbind("dragover.ACRestUpload"),b.dropZone.unbind("dragleave.ACRestUpload"),b.dropZone.unbind("drop.ACRestUpload"),b.dropZone.unbind("click.ACRestUpload"),b.hiddenInput.unbind("change.ACRestUpload"),this.fallbackMode||(b.dropZone.bind("dragover.ACRestUpload",b.handleDragOver),b.dropZone.bind("dragleave.ACRestUpload",b.handleDragLeave),b.dropZone.bind("drop.ACRestUpload",b.handleFileSelect),b.dropZone.bind("click.ACRestUpload",b.handleClick),b.hiddenInput.bind("change.ACRestUpload",b.handleHiddenInputChange))},b.fileClicked=function(a){"success"==a.result.response?""!==a.result.documentId&&window.open(b.getInstanceUrl()+"/"+a.result.documentId,"Document"):"error"==a.result.response&&alert("Error: "+a.result.error)},b.getInstanceUrl=function(){return b.instanceUrl},b.getProxyUrl=function(){var a=location.protocol+"//"+location.host,b=location.pathname.split("/");return b.length>1&&"apex"!=b[1]&&(a+="/"+b[1]),a+="/services/proxy"},b.init(a),b}function FileUpload(a,b,c){var d=this;return d.dom_id="thumb_"+b,d.contentId=-1,d.file=a,d.fileName=this.file.name,d.chunkSize=18e4,d.start=0,d.stop=this.chunkSize-1,d.reader=new FileReader,d.thumb={},d.$container={},d.$thumbnail={},d.$progressbar={},d.uploader=c,d.result={},d.init=function(){d.createContainer(),d.generateThumbnail(),d.bindEvents()},d.bindEvents=function(){$j(d.$container).css("cursor","pointer"),$j(d.$container).click(function(){d.uploader.fileClicked(d)})},d.createContainer=function(){var a='<div id="'+d.dom_id+'" class="uploadContainer"><div class="success">✔</div><div class="error">✕</div><div class="thumbnailContainer"><span class="fileName">'+d.fileName+'</span></div><div class="progressBar"><div class="percent" align="center">Waiting...</div></div></div>';$j(d.uploader.uploadList).prepend(a),d.$container=$j("#"+d.dom_id),d.$progressbar=d.$container.children(".progressBar")},d.generateThumbnail=function(){if(a.type.match("image.*")){var b=new FileReader;b.onload=function(a){return function(b){var c='<img class="thumb" src="'+b.target.result+'" title="'+escape(a.name)+'"/>';$j(d.$container).children(".thumbnailContainer").append(c),d.$thumbnail=$j(d.$container).children(".thumb")}}(d.file),b.readAsDataURL(a)}},d.documentCreated=function(a,b){b.status?(d.contentId=a,d.processNextChunk()):$j(d.$progressbar).children(".percent").text("Error")},d.upload=function(){d.reader.onload=d.fileLoaded,d.reader.readAsArrayBuffer(d.file)},d.fileLoaded=function(a){var b=a.target.result,e=c.getInstanceUrl()+"/services/apexrest/ContentUploadHandler",f=c.getProxyUrl();d.xhr=new XMLHttpRequest,d.xhr.open("POST",f,!0),d.xhr.setRequestHeader("SalesforceProxy-Endpoint",e),d.xhr.setRequestHeader("Accept","application/json"),d.xhr.setRequestHeader("Cache-Control","no-cache"),d.xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),d.xhr.setRequestHeader("X-File-Name",d.fileName),d.xhr.setRequestHeader("Authorization","OAuth "+d.uploader.sf_sessionId),d.xhr.setRequestHeader("X-User-Agent","salesforce-toolkit-rest-javascript/v27.0"),d.xhr.setRequestHeader("upload_filename",d.fileName),d.xhr.setRequestHeader("data",JSON.stringify(d.uploader.data)),d.xhr.onload=function(){""!==d.xhr.responseText&&(d.result=JSON.parse(d.xhr.responseText),"success"==d.result.response?d.completed():(log("Error: "+d.xhr.responseText),d.errored(d.result.error)))},d.xhr.onerror=function(){d.errored(d.xhr.responseText)},d.xhr.upload.onprogress=function(a){var b=Math.round(Math.max(0,Math.min(100,100*(a.loaded/a.total))));d.updateProgress(b)},d.xhr.send(b)},d.updateProgress=function(a){$j(d.$progressbar).css("width",a+"%"),$j(d.$progressbar).children(".percent").text(a+"%")},d.errored=function(){$j(d.$container).children(".error").show(),$j(d.$progressbar).children(".percent").text("Error"),d.uploader.fileUploaded(d)},d.completed=function(){$j(d.$container).children(".success").show(),d.uploader.fileUploaded(d)},d.init(),d}function log(a){("undefined"!=typeof console||"undefined"!=typeof console.log)&&console.log(a)}function supportAjaxUploadProgressEvents(){var a=new XMLHttpRequest;return!!(a&&"upload"in a&&"onprogress"in a.upload)}$j=jQuery.noConflict();