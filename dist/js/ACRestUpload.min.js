/*! ACRestUploader 2015-06-15 */
function ACRestUpload(a){var b=this;return b.id=null,b.manualUpload=!1,b.fileArray=[],b.fileCnt=0,b.uploadingFileCnt=0,b.data=null,b.html5Form={},b.dropZone={},b.uploadList={},b.hiddenInput={},b.sf_sessionId="",b.finishedCallback=null,b.fileUploadCallback=null,b.finished=!1,b.useProxy=!0,b.uploadLimit=999,b.init=function(a){b.id=a.selector,b.html5Form=$j(b.id).children(".html5form"),b.dropZone=$j(b.html5Form).children(".dropZone"),b.hiddenInput=$j(b.html5Form).children(".hidden_input"),b.uploadList=$j(b.html5Form).children(".uploadList"),b.sf_sessionId=a.session,b.instanceUrl=a.instanceUrl},b.setData=function(a){b.data=a},b.prepareUpload=function(a){b.data=a.data,a.uploadLimit&&(b.uploadLimit=a.uploadLimit,b.applyUploadLimit());var c=window[a.fileUploadCallback];"function"==typeof c&&(b.fileUploadCallback=c),c=window[a.finishedCallback],"function"==typeof c&&(b.finishedCallback=c),b.bindEvents(),a.manualUpload&&(b.manualUpload=a.manualUpload),b.fileArray=[],b.fileCnt=0,$j(b.uploadList).empty()},b.applyUploadLimit=function(){var a="file"+(b.uploadLimit>1?"s":"");$j(b.html5Form).find(".uploadLimitLbl").text("max. "+b.uploadLimit+" "+a)},b.startManualUpload=function(){b.startUploads()},b.startUploads=function(){if(0==b.fileArray.length)b.finishedCallback();else for(u in b.fileArray){var a=b.fileArray[u];a.upload(),b.uploadingFileCnt++}},b.handleFileSelect=function(a){$j("#drop_zone").removeClass("dropZoneHovering"),a.stopPropagation(),a.preventDefault();var c=a.originalEvent.dataTransfer.files;b.handleFiles(c)},b.handleFiles=function(a){b.finished=!1;for(var c,d=0;c=a[d];d++){if(!(b.fileCnt<b.uploadLimit)){var e="file"+(b.uploadLimit>1?"s":"");return alert("You may only upload "+b.uploadLimit+" "+e),void 0}var f=new FileUpload(c,b.fileCnt,b);b.fileArray.push(f),b.fileCnt++,b.manualUpload||(f.upload(),b.uploadingFileCnt++)}},b.fileUploaded=function(a){b.uploadingFileCnt--,b.fileUploadCallback&&b.fileUploadCallback(a.fileName),0==b.uploadingFileCnt&&b.finishedCallback&&(b.finished=!0,b.finishedCallback())},b.handleDragLeave=function(){$j("#drop_zone").removeClass("dropZoneHovering")},b.handleDragOver=function(a){$j("#drop_zone").addClass("dropZoneHovering"),a.stopPropagation(),a.preventDefault(),a.originalEvent.dataTransfer.dropEffect="copy"},b.handleHiddenInputChange=function(){var a=this.files;a.length&&b.handleFiles(a)},b.handleClick=function(a){a.preventDefault(),b.hiddenInput.click()},b.bindEvents=function(){b.dropZone.unbind("dragover.ACRestUpload"),b.dropZone.unbind("dragleave.ACRestUpload"),b.dropZone.unbind("drop.ACRestUpload"),b.dropZone.unbind("click.ACRestUpload"),b.hiddenInput.unbind("change.ACRestUpload"),b.dropZone.bind("dragover.ACRestUpload",b.handleDragOver),b.dropZone.bind("dragleave.ACRestUpload",b.handleDragLeave),b.dropZone.bind("drop.ACRestUpload",b.handleFileSelect),b.dropZone.bind("click.ACRestUpload",b.handleClick),b.hiddenInput.bind("change.ACRestUpload",b.handleHiddenInputChange)},b.fileClicked=function(a){"success"==a.result.response?""!==a.result.documentId&&window.open(b.getInstanceUrl()+"/"+a.result.documentId,"Document"):"error"==a.result.response&&alert("Error: "+a.result.error)},b.getInstanceUrl=function(){return b.instanceUrl},b.getProxyUrl=function(){var a=location.protocol+"//"+location.host,b=location.pathname.split("/");return b.length>1&&"apex"!=b[1]&&(a+="/"+b[1]),a+="/services/proxy"},b.init(a),b}function FileUpload(a,b,c){var d=this;return d.dom_id="thumb_"+b,d.contentId=-1,d.file=a,d.fileName=this.file.name,d.chunkSize=18e4,d.start=0,d.stop=this.chunkSize-1,d.reader=new FileReader,d.thumb={},d.$container={},d.$thumbnail={},d.$progressbar={},d.uploader=c,d.result={},d.init=function(){d.createContainer(),d.generateThumbnail(),d.bindEvents()},d.bindEvents=function(){$j(d.$container).css("cursor","pointer"),$j(d.$container).click(function(){d.uploader.fileClicked(d)})},d.createContainer=function(){var a='<div id="'+d.dom_id+'" class="uploadContainer"><div class="success">✔</div><div class="error">✕</div><div class="thumbnailContainer"><span class="fileName">'+d.fileName+'</span></div><div class="progressBar"><div class="percent" align="center">Waiting...</div></div></div>';$j(d.uploader.uploadList).prepend(a),d.$container=$j("#"+d.dom_id),d.$progressbar=d.$container.children(".progressBar")},d.generateThumbnail=function(){if(a.type.match("image.*")){var b=new FileReader;b.onload=function(a){return function(b){var c='<img class="thumb" src="'+b.target.result+'" title="'+escape(a.name)+'"/>';$j(d.$container).children(".thumbnailContainer").append(c),d.$thumbnail=$j(d.$container).children(".thumb")}}(d.file),b.readAsDataURL(a)}},d.documentCreated=function(a,b){b.status?(d.contentId=a,d.processNextChunk()):$j(d.$progressbar).children(".percent").text("Error")},d.upload=function(){d.reader.onload=d.fileLoaded,d.reader.onprogress=d.fileProgress,d.reader.readAsArrayBuffer(d.file)},d.fileProgress=function(a){if(a.lengthComputable){var b=Math.round(100*(a.loaded/a.total));d.updateProgress(b)}},d.fileLoaded=function(a){var b=a.target.result,e=c.getInstanceUrl()+"/services/apexrest/ContentUploadHandler",f=c.getProxyUrl();$j.ajax({type:"POST",dataType:"json",url:f,cache:!1,async:!0,data:b,processData:!1,contentType:!1,error:function(a){d.errored(a.responseText)},xhr:function(){var a=new window.XMLHttpRequest;return a.upload.addEventListener("progress",function(a){if(a.lengthComputable){var b=Math.round(100*(a.loaded/a.total));d.updateProgress(b)}},!1),a.addEventListener("progress",function(a){if(a.lengthComputable){var b=Math.round(100*(a.loaded/a.total));d.updateProgress(b)}},!1),a},beforeSend:function(a){a.setRequestHeader("SalesforceProxy-Endpoint",e),a.setRequestHeader("Accept","application/json"),a.setRequestHeader("Cache-Control","no-cache"),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.setRequestHeader("X-File-Name",d.fileName),a.setRequestHeader("Authorization","OAuth "+d.uploader.sf_sessionId),a.setRequestHeader("X-User-Agent","salesforce-toolkit-rest-javascript/v27.0"),a.setRequestHeader("upload_filename",d.fileName),a.setRequestHeader("data",JSON.stringify(d.uploader.data))},complete:function(){d.updateProgress(100)},success:function(){d.updateProgress(100),d.completed()}})},d.updateProgress=function(a){$j(d.$progressbar).css("width",a+"%"),$j(d.$progressbar).children(".percent").text(a+"%")},d.errored=function(){$j(d.$container).children(".error").show(),$j(d.$progressbar).children(".percent").text("Error"),d.uploader.fileUploaded(d)},d.completed=function(){$j(d.$container).children(".success").show(),d.uploader.fileUploaded(d)},d.init(),d}$j=jQuery.noConflict();